# Quick Ask 快速问答 - 功能设计文档

> **版本**: v0.1 (设计阶段)  
> **创建日期**: 2025-11-27  
> **状态**: 📝 讨论中

---

## 1. 问题与动机

### 1.1 用户痛点

当用户看到屏幕上的某个问题，想要**瞬间提问**时：

- 🐌 传统流程：截图 → 打开 APP → 粘贴图片 → 输入问题 → 等待回答
- ⚡ 期望流程：按快捷键 → 边说边打字 → 回车发送 → 看到回答

**核心诉求**：减少从"想问"到"问出"的摩擦，让提问像呼吸一样自然。

### 1.2 与现有功能的区别

| 维度       | 现有听写模式               | Quick Ask 模式             |
| ---------- | -------------------------- | -------------------------- |
| **目的**   | 语音转文字，输出到光标位置 | 向 AI 提问，获取回答       |
| **触发**   | 按快捷键后"正在聆听"       | 按快捷键后**立即开始录音** |
| **输出**   | 文本粘贴到当前 App         | 弹出 AI 对话窗口           |
| **上下文** | 当前活跃 App               | 当前屏幕截图 + 用户输入    |

---

## 2. 用户故事 (User Stories)

### US-1: 快速发起提问

> 作为用户，我希望按一个快捷键就能立即开始录音提问，这样我不用等待"正在聆听"状态。

**验收标准 (AC)**:

- [ ] 按下 Quick Ask 快捷键后，立即开始录音
- [ ] HUD 显示录音波形，不显示"正在聆听"文字
- [ ] 录音过程中，用户可以同时在输入框中打字

### US-2: 文字修正语音转写

> 作为用户，我希望在语音录制的同时能输入文字，用于修正语音转写中可能出错的关键词。

**验收标准 (AC)**:

- [ ] HUD 上方显示语音波形，下方提供输入框
- [ ] 按下快捷键后，输入框自动获得焦点
- [ ] 用户输入的文字作为"修正/补充"信息发送给 AI

### US-3: 灵活的发送方式

> 作为用户，我希望可以通过回车键或再按一次快捷键来发送提问。

**验收标准 (AC)**:

- [ ] 按 `Enter` 键：结束录音并发送
- [ ] 再按一次 Quick Ask 快捷键：结束录音并发送
- [ ] 发送前可选择是否附带当前屏幕截图（后续功能）

### US-4: 放弃与重录

> 作为用户，我希望在录音过程中可以放弃这次提问或重新开始录音。

**验收标准 (AC)**:

- [ ] Hover HUD 时显示两个按钮："放弃" 和 "重新录音"
- [ ] 点击"放弃"：取消本次提问，HUD 关闭
- [ ] 点击"重新录音"：清空当前内容，重新开始

### US-5: AI 理解语音转写的不确定性

> 作为用户，我希望 AI 能理解语音转写可能有偏差，根据我的文字输入进行推断。

**验收标准 (AC)**:

- [ ] Prompt 组合区分「用户输入」和「语音转写」
- [ ] 提示 AI："语音转写可能存在偏差，请结合用户输入理解意图"
- [ ] AI 能够根据上下文智能修正术语/人名等

### US-6: 查看 AI 回答

> 作为用户，我希望发送提问后能看到一个清晰的回答界面。

**验收标准 (AC)**:

- [ ] 发送后弹出对话窗口（参考第二张设计图）
- [ ] 显示：用户问题（含截图）+ AI 回答
- [ ] 支持继续追问（后续功能）

---

## 3. 交互流程

```
┌─────────────────────────────────────────────────────────────┐
│                      Quick Ask 交互流程                       │
└─────────────────────────────────────────────────────────────┘

[用户按下快捷键]
        │
        ▼
┌───────────────────┐
│   立即开始录音      │
│   HUD 弹出         │
│   输入框获得焦点    │
└───────────────────┘
        │
        │ (用户可以)
        │ ├── 说话（语音录制中）
        │ ├── 打字（输入框补充/修正）
        │ └── Hover 查看操作按钮
        │
        ▼
    ┌───────┬───────────┐
    │       │           │
    ▼       ▼           ▼
[Enter]  [快捷键]    [Hover]
    │       │           │
    │       │           ├── 放弃 → 取消关闭
    │       │           └── 重录 → 清空重来
    │       │
    └───┬───┘
        ▼
┌───────────────────┐
│   结束录音          │
│   (可选) 截图       │
│   组装 Prompt       │
│   发送给 AI         │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│   AI 回答窗口       │
│   显示问题+回答     │
│   支持继续追问      │
└───────────────────┘
```

---

## 4. Prompt 组装策略

### 4.1 输入来源

1. **用户文字输入** (User Input): 用户在输入框中打的字
2. **语音转写** (Voice Transcription): 语音识别的文字
3. **屏幕截图** (Screenshot): 发送时的屏幕截图（可选）

### 4.2 Prompt 模板

```markdown
## 用户问题

### 用户输入

{user_input}

### 语音转写

{voice_transcription}

> 注意：语音转写可能存在偏差（如专业术语、人名、缩写等），请结合用户输入理解真实意图。

### 屏幕上下文

[附带屏幕截图]
```

### 4.3 示例

```markdown
## 用户问题

### 用户输入

SwiftUI animation

### 语音转写

我想问一下这个 swift UI 的动画怎么写

> 注意：语音转写可能存在偏差，请结合用户输入理解真实意图。

### 屏幕上下文

[截图：Xcode 代码界面]
```

AI 应该能够：

- 理解 "swift UI" 实际是 "SwiftUI"
- 结合截图理解具体是哪段代码需要添加动画

---

## 5. UI/UX 设计要点

### 5.1 设计原则

**复用现有 HUD 样式**：Quick Ask 模式与语音转文字模式共享同一套视觉风格，保持产品一致性。

**核心改动**：只修改上方区域，下方控制栏保持不变。

### 5.2 HUD 布局对比

#### 现有：语音转文字模式

```text
┌────────────────────────────────────────────────┐
│                                                │
│   正在聆听...                                   │  ← textArea (实时转写)
│                                                │
├────────────────────────────────────────────────┤
│  [W]  ▁▁▂▃▅▂▁▃▅▂▁▁▁    🎙️ SpokenAnyWhere      │  ← controlBar (复用)
└────────────────────────────────────────────────┘
```

#### 新增：Quick Ask 模式

```text
┌────────────────────────────────────────────────┐
│                                                │
│   [🖼️] [🖼️] [📄]                               │  ← 附件缩略图 (最上层)
│                                                │
│   Ask anything...                              │  ← inputArea (输入框)
│   用户输入的问题...                              │  ← 用户文字
│                                                │
├────────────────────────────────────────────────┤
│  [W]  ▁▁▂▃▅▂▁▃▅▂▁▁▁    🎙️ SpokenAnyWhere      │  ← controlBar (复用)
└────────────────────────────────────────────────┘
```

### 5.3 布局对比

| 区域      | 语音转文字模式           | Quick Ask 模式            |
| --------- | ------------------------ | ------------------------- |
| **上方**  | `textArea` 实时转写文本  | `inputArea` 输入框 + 附件 |
| **下方**  | `controlBar` 波形 + 品牌 | `controlBar` 复用不变     |
| **Hover** | 完成录音 / 取消录音      | 放弃 / 重新录音           |

### 5.4 输入区域详细设计

#### 5.4.1 输入框 (inputArea)

- **Placeholder**: "Ask anything (⌥T)" 或 自定义快捷键提示
- **自动聚焦**: 触发 Quick Ask 后输入框自动获得焦点
- **多行支持**: 支持换行，高度自适应（向上扩展）
- **富文本支持**: 可粘贴图片、文件拖拽

#### 5.4.2 附件支持

支持以下类型的附件：

| 类型     | 交互方式       | 显示形式             |
| -------- | -------------- | -------------------- |
| **图片** | 粘贴 / 拖拽    | 缩略图预览           |
| **文件** | 拖拽           | 文件图标 + 文件名    |
| **URL**  | 粘贴           | 链接预览卡片（可选） |
| **截图** | 快捷键自动截图 | 缩略图预览           |

#### 5.4.3 悬浮保持

**关键特性**：HUD 窗口保持悬浮，用户可以：

1. 切换到其他应用找图/找资料
2. 将图片/文件拖拽到 HUD 输入框
3. 返回 HUD 继续输入或发送

这解决了"边聊天边找资料"的场景需求。

### 5.5 控制栏 (复用现有)

完全复用 `FloatingCapsuleView.controlBar`：

```swift
// 现有代码结构
private var controlBar: some View {
    HStack(spacing: 0) {
        appIcon                    // 左侧：当前 App 图标
        Spacer().frame(width: 12)
        ScrollingWaveform(...)     // 中间：音频波形
        Spacer()
        brandLabel                 // 右侧：SpokenAnyWhere 品牌
    }
}
```

Quick Ask 模式下：

- `appIcon`: 保持显示当前目标 App
- `waveform`: 显示录音波形（实时）
- 右侧可增加「发送」按钮图标

### 5.6 Hover 操作

Quick Ask 模式下的 Hover 操作：

| 操作         | 图标                | 效果                                 |
| ------------ | ------------------- | ------------------------------------ |
| **放弃**     | `xmark.circle.fill` | 取消本次提问，关闭 HUD               |
| **重新录音** | `arrow.clockwise`   | 清空语音，保留文字输入，重新开始录音 |

### 5.7 发送方式

- **Enter 键**: 发送（无需 Shift+Enter）
- **再按快捷键**: 发送
- **点击发送按钮**: 发送（可选，控制栏右侧）

### 5.8 回答窗口 (Answer Panel)

发送后弹出悬浮窗口显示 AI 回答。

#### 5.8.1 窗口结构

```text
┌─────────────────────────────────────────────────────────┐
│  ⊗
│                                                         │
│      [ 截图缩略图]                                     │
│                                         ┌─────────────┐ │
│                                         │ 这个是什么   │ │
│                                         └─────────────┘ │
│                                                         │
│  这是一个名为 SpokenAnyWhere 的软件界面...               │
│                                                         │
│  从界面布局能看到：                                       │
│  • 左侧是功能菜单（常规、听写模型、AI 处理...）            │
│  • 右侧 "历史记录" 标签下，展示了过往的操作...             │
│                                                         │
│  语音播放  复制  刷新  更多  点赞/踩                              │
│                                                         │
│  ┌─────────────────────────────────────────┐            │
│  │ SpokenAnyWhere有哪些特色功能？  →        │            │
│  │ 如何使用SpokenAnyWhere进行语音转文字？ → │            │
│  │ SpokenAnyWhere的AI处理功能可以实现...  → │            │
│  └─────────────────────────────────────────┘            │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  ...                                                    │
│  复制                                           🎙️  ⬆️ │
└─────────────────────────────────────────────────────────┘
```

#### 5.8.2 组件说明

| 区域           | 功能                                        |
| -------------- | ------------------------------------------- |
| **顶部工具栏** | 关闭、全屏、历史记录、新建对话              |
| **用户消息**   | 显示截图缩略图 + 用户问题（右对齐气泡）     |
| **AI 回答**    | Markdown 渲染（左对齐），支持列表、代码块等 |
| **操作按钮**   | 语音播放、复制、刷新、更多、点赞/踩         |
| **推荐问题**   | AI 生成的后续问题建议，点击可继续追问       |
| **输入框**     | 继续追问，支持语音输入、附件、联网搜索等    |

#### 5.8.3 窗口特性

- **悬浮置顶**: 始终保持在最前
- **可拖拽**: 用户可拖动窗口位置
- **可调整大小**: 支持拉伸窗口
- **多轮对话**: 支持连续追问，保持上下文

---

## 6. 技术考量

### 6.1 需要新增/修改的组件

- [ ] `QuickAskService`: 管理 Quick Ask 流程
- [ ] `HUDView` 扩展: 支持 Quick Ask 模式的 UI
- [ ] `PromptBuilder` 扩展: 组装 Quick Ask 专用 Prompt
- [ ] `ScreenshotService`: 截图功能（可选）
- [ ] `ConversationView`: AI 对话窗口

### 6.2 与现有功能的兼容

- 使用独立的快捷键，不影响现有听写功能
- 复用 `AudioRecordingService`、`TranscriptionService`
- 复用现有 LLM Provider 配置

---

## 7. 分期实现建议

### Phase 1: MVP

- [x] 快捷键触发立即录音
- [x] HUD 显示波形 + 输入框
- [x] Enter/快捷键发送
- [x] 放弃/重录按钮
- [x] 基础 Prompt 组装
- [x] 简单回答展示

### Phase 2: 增强

- [ ] 更丰富的回答渲染

### Phase 3: 进阶

- [ ] 多轮对话支持
- [ ] 历史记录保存
- [ ] 语音回答 (TTS)
- [ ] 快捷操作（复制代码、执行命令等）

---

## 8. 开放问题 (待讨论)

1. **快捷键设置**: 使用独立快捷键还是组合键区分模式？
2. **截图时机**: 发送前截图还是触发时截图？
3. **回答窗口位置**: 固定位置还是跟随光标？
4. **多轮对话**: MVP 是否支持继续追问？
5. **错误处理**: AI 超时/失败时如何处理？

---

## 附录: 设计参考图

### A. 录音状态 HUD

![Recording HUD](./image-quick-ask-recording.png)

- 语音波形显示
- 输入框用于补充/修正

### B. AI 回答窗口

![Answer Window](./image-quick-ask-answer.png)

- 显示截图 + 问题
- AI 回答（Markdown 格式）
- 底部继续追问输入框
