name: Build and Release

on:
  push:
    tags:
      - "v*" # 推送 v1.0.0 这样的 tag 时触发
  workflow_dispatch: # 手动触发

env:
  APP_NAME: SpokenAnyWhere
  SCHEME: SpokenAnyWhere

jobs:
  build:
    runs-on: macos-14 # Apple Silicon runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: Build Release
        working-directory: spoke
        run: |
          swift build -c release

      - name: Create App Bundle
        working-directory: spoke
        run: |
          mkdir -p dist/SpokenAnyWhere.app/Contents/MacOS
          mkdir -p dist/SpokenAnyWhere.app/Contents/Resources

          # 复制可执行文件
          cp .build/release/SpokenAnyWhere dist/SpokenAnyWhere.app/Contents/MacOS/

          # 创建 Info.plist
          cat > dist/SpokenAnyWhere.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>SpokenAnyWhere</string>
            <key>CFBundleIdentifier</key>
            <string>com.spokeanywhere</string>
            <key>CFBundleName</key>
            <string>SpokenAnyWhere</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSMinimumSystemVersion</key>
            <string>14.0</string>
            <key>LSUIElement</key>
            <true/>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSMicrophoneUsageDescription</key>
            <string>SpokenAnyWhere needs microphone access for voice transcription.</string>
          </dict>
          </plist>
          EOF

          ls -la dist/

      - name: Create DMG
        working-directory: spoke
        run: |
          # 创建 DMG
          hdiutil create -volname "SpokenAnyWhere" \
            -srcfolder dist/SpokenAnyWhere.app \
            -ov -format UDZO \
            dist/SpokenAnyWhere.dmg

          ls -la dist/

      - name: Create ZIP
        working-directory: spoke
        run: |
          cd dist
          zip -r SpokenAnyWhere.zip SpokenAnyWhere.app
          ls -la

      - name: Get Version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: SpokenAnyWhere ${{ steps.version.outputs.version }}
          body: |
            ## SpokenAnyWhere ${{ steps.version.outputs.version }}

            ### 安装说明
            1. 下载 `.dmg` 文件
            2. 打开 DMG，将应用拖入 Applications 文件夹
            3. 首次运行需要在「系统设置 > 隐私与安全性」中允许运行
            4. 授予辅助功能和麦克风权限

            ### 下载
            - **DMG**: SpokenAnyWhere.dmg (推荐)
            - **ZIP**: SpokenAnyWhere.zip
          files: |
            spoke/dist/SpokenAnyWhere.dmg
            spoke/dist/SpokenAnyWhere.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts (for non-tag builds)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: SpokenAnyWhere-${{ steps.version.outputs.version }}
          path: |
            spoke/dist/SpokenAnyWhere.dmg
            spoke/dist/SpokenAnyWhere.zip
